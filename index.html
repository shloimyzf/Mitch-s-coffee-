<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Mitch's Admin</title>
  
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon.png">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  
  <script type="text/javascript">
    (function(){ emailjs.init("X_5xpqldnPZM4GwJh"); })();
  </script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
    body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
    .animate-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body class="bg-stone-900 text-white pb-20 select-none">

<div id="main-view" class="max-w-md mx-auto p-4">
    <div class="min-h-screen flex flex-col items-center justify-center gap-4">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white"></div>
    </div>
</div>

<div id="toast-layer" class="fixed top-4 left-4 right-4 z-[60] pointer-events-none"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
  import { getFirestore, collection, onSnapshot, doc, updateDoc, deleteDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
  import { getMessaging, getToken } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-messaging.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCMcxuH-8Pc0t8eC71xOU8TXLu0ZoF-RG4",
    authDomain: "mitches-coffee.firebaseapp.com",
    projectId: "mitches-coffee",
    storageBucket: "mitches-coffee.firebasestorage.app",
    messagingSenderId: "789709713646",
    appId: "1:789709713646:web:3f09ce026b40a85b3f03ff"
  };

  const VAPID_KEY = "BF3iJzRgdCJq3LAFW2c05_5m-dGyzGhS74-_G4ty609IzftV92_inFfBP9ThuDAZ7FJd2V27VvNFgJsyOk8lzg4";
  const appId = "mitchs-coffee";

  const EMAIL_SERVICE_ID = "service_m3qf2td";
  const EMAIL_TEMPLATE_ID = "template_c7bbquk"; 
  const CARRIERS = { "Verizon": "@vtext.com", "AT&T": "@txt.att.net", "T-Mobile": "@tmomail.net", "Sprint": "@messaging.sprintpcs.com", "None": "" };

  let db, auth, messaging;
  let state = {
    orders: [], settings: { deliveryEnabled: true, shopOpen: true }, fcmToken: null, lastId: null
  };

  async function init() {
    const app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    auth = getAuth(app);
    messaging = getMessaging(app);

    if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js'); }

    await signInAnonymously(auth);
    onAuthStateChanged(auth, user => {
      if (user) {
          listenOrders();
          listenSettings();
          if(Notification.permission === 'granted') requestPushPermission(); 
      }
    });

    setInterval(() => { renderMain(); }, 15000); 
  }

  window.requestPushPermission = async () => {
    try {
        const token = await getToken(messaging, { vapidKey: VAPID_KEY });
        if (token) { state.fcmToken = token; showToast("Admin Notifications On"); renderMain(); }
    } catch (err) { console.log(err); }
  };

  function listenOrders() {
    onSnapshot(collection(db, "artifacts", appId, "public", "data", "orders"), snap => {
      state.orders = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
      // No sound, just toast
      if(state.orders.length > 0) {
        const latest = state.orders[0];
        if(latest.status === 'pending' && state.lastId !== latest.id) {
            state.lastId = latest.id;
            showToast(`New Order: ${latest.customerName}`);
        }
      }
      renderMain();
    });
  }

  function listenSettings() {
      const docRef = doc(db, "artifacts", appId, "public", "data", "settings", "global");
      onSnapshot(docRef, (docSnap) => {
          if (docSnap.exists()) { state.settings = docSnap.data(); renderMain(); } 
          else { setDoc(docRef, { deliveryEnabled: true, shopOpen: true }); }
      });
  }

  window.toggleDeliverySetting = () => { setDoc(doc(db, "artifacts", appId, "public", "data", "settings", "global"), { deliveryEnabled: !state.settings.deliveryEnabled }, { merge: true }); };
  window.toggleShopOpen = () => { setDoc(doc(db, "artifacts", appId, "public", "data", "settings", "global"), { shopOpen: !state.settings.shopOpen }, { merge: true }); };

  function sendNotifyToStudent(order) {
    const message = `Hey ${order.customerName}, your Mitch's Coffee order is READY! Come to room 101.`;
    const fromName = "Mitch's Coffee";
    const replyTo = "noreply@mitchscoffee.com";

    if (order.customerPhone && order.customerCarrier && order.customerCarrier !== 'None') {
        emailjs.send(EMAIL_SERVICE_ID, EMAIL_TEMPLATE_ID, { to_email: order.customerPhone + CARRIERS[order.customerCarrier], name: fromName, email: replyTo, message: message });
    }
    if (order.customerEmail) {
        emailjs.send(EMAIL_SERVICE_ID, EMAIL_TEMPLATE_ID, { to_email: order.customerEmail, name: fromName, email: replyTo, message: message });
    }
  }

  window.setStatus = (id, s) => { 
      updateDoc(doc(db,"artifacts",appId,"public","data","orders",id), { status: s }); 
      if (s === 'ready') { const order = state.orders.find(o => o.id === id); if (order) sendNotifyToStudent(order); } 
  };
  window.deleteOrder = id => deleteDoc(doc(db,"artifacts",appId,"public","data","orders",id));
  window.restartApp = () => { window.location.href = window.location.href; };
  
  function showToast(m) { const t = document.getElementById("toast-layer"); t.innerHTML = `<div class="animate-bounce bg-white text-black px-6 py-3 rounded-2xl shadow-2xl text-center font-bold mx-auto max-w-xs">${m}</div>`; setTimeout(() => { t.innerHTML = ''; }, 3000); }

  function renderMain() {
    const root = document.getElementById("main-view");
    root.innerHTML = `
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-black italic">Mitch's Admin</h1>
            <div class="flex gap-2">
                 <button onclick="requestPushPermission()" class="text-[10px] font-bold border border-white/20 px-3 py-1 rounded-lg uppercase ${state.fcmToken ? 'bg-green-500 text-white border-none' : 'text-stone-400'}">Alerts ${state.fcmToken ? 'ON' : 'OFF'}</button>
                 <button onclick="restartApp()" class="text-[10px] font-bold border border-white/20 px-3 py-1 rounded-lg uppercase">Refresh</button>
            </div>
        </div>
        
        <div class="grid grid-cols-2 gap-2 mb-6">
             <div class="bg-white/10 p-4 rounded-2xl flex flex-col items-center justify-center gap-2">
                <span class="text-[10px] font-bold uppercase text-stone-400">Shop Status</span>
                <button onclick="toggleShopOpen()" class="w-full py-2 rounded-xl font-black text-sm uppercase transition-colors ${state.settings.shopOpen ? 'bg-green-500 text-white' : 'bg-red-500 text-white'}">
                    ${state.settings.shopOpen ? 'OPEN' : 'CLOSED'}
                </button>
            </div>
            <div class="bg-white/10 p-4 rounded-2xl flex flex-col items-center justify-center gap-2">
                <span class="text-[10px] font-bold uppercase text-stone-400">Delivery</span>
                <button onclick="toggleDeliverySetting()" class="w-full py-2 rounded-xl font-black text-sm uppercase transition-colors ${state.settings.deliveryEnabled ? 'bg-blue-600 text-white' : 'bg-stone-700 text-stone-500'}">
                    ${state.settings.deliveryEnabled ? 'ON' : 'OFF'}
                </button>
            </div>
        </div>

        ${state.orders.length === 0 ? '<div class="text-center py-20 text-stone-600 font-bold italic border-2 border-stone-800 rounded-3xl border-dashed">No orders yet.</div>' : ''}
        
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        ${state.orders.map(o => `
            <div class="bg-white text-black p-4 rounded-[1.5rem] border-2 shadow-lg ${o.status==='completed'?'opacity-50 border-stone-200':'border-[#924E23]'} flex flex-col justify-between animate-in">
                <div class="mb-3">
                    <div class="flex justify-between items-start mb-2">
                        <div class="overflow-hidden">
                            <h3 class="font-black text-lg truncate leading-tight">${o.customerName}</h3>
                             ${o.isDelivery ? `<span class="bg-blue-600 text-white text-[10px] font-black px-2 py-0.5 rounded uppercase block w-fit mt-1">Delivery: ${o.dormRoom}</span>` : `<span class="bg-stone-200 text-stone-700 text-[10px] font-black px-2 py-0.5 rounded uppercase block w-fit mt-1">Pickup</span>`}
                        </div>
                        <button onclick="deleteOrder('${o.id}')" class="text-stone-300 hover:text-red-500 p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                    <div class="space-y-1 text-xs font-medium text-stone-600">
                        ${o.items.map(it => `<div class="border-b border-stone-100 pb-1 last:border-0 flex justify-between"><span class="font-bold text-stone-900">${it.qty}x ${it.name}</span><span class="text-stone-400">${it.size} ${it.type==='drink' && it.syrupType!=='None' ? `(${it.syrupPumps}p ${it.syrupType})` : ''}</span></div>`).join('')}
                    </div>
                </div>
                <div class="flex flex-col gap-2 mt-auto">
                    ${o.status === 'pending' ? `<button onclick="setStatus('${o.id}', 'brewing')" class="w-full bg-[#924E23] text-white py-3 rounded-xl font-black text-sm uppercase shadow-md active:scale-95">Start Brewing</button>` : ''}
                    ${o.status === 'brewing' ? `<button onclick="setStatus('${o.id}', 'ready')" class="w-full bg-green-600 text-white py-3 rounded-xl font-black text-sm uppercase shadow-md active:scale-95">Ready for Pickup</button>` : ''}
                    ${o.status === 'ready' ? `<button onclick="setStatus('${o.id}', 'completed')" class="w-full bg-stone-900 text-white py-3 rounded-xl font-black text-sm uppercase shadow-md active:scale-95">Archive</button>` : ''}
                    <div class="text-[10px] font-black text-center text-stone-300 uppercase tracking-widest">${o.status}</div>
                </div>
            </div>`).join('')}
        </div>
    `;
    lucide.createIcons();
  }

  init();
</script>
</body>
</html>
